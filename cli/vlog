#!/usr/bin/env python3
"""
VLog CLI - Command line interface for video management.
"""
import argparse
import os
import sys
from pathlib import Path
import httpx

sys.path.insert(0, str(Path(__file__).parent.parent))

from config import ADMIN_PORT

# Download timeout in seconds (default 1 hour, configurable via environment)
DOWNLOAD_TIMEOUT = int(os.getenv("VLOG_DOWNLOAD_TIMEOUT", "3600"))

API_BASE = f"http://localhost:{ADMIN_PORT}/api"


def cmd_upload(args):
    """Upload a video."""
    file_path = Path(args.file)
    if not file_path.exists():
        print(f"Error: File not found: {file_path}")
        sys.exit(1)

    title = args.title or file_path.stem.replace("-", " ").replace("_", " ").title()

    print(f"Uploading: {file_path.name}")
    print(f"Title: {title}")

    with open(file_path, "rb") as f:
        files = {"file": (file_path.name, f)}
        data = {
            "title": title,
            "description": args.description or "",
        }
        if args.category:
            # Look up category ID by name/slug
            cats = httpx.get(f"{API_BASE}/categories").json()
            cat_match = None
            for cat in cats:
                if cat["name"].lower() == args.category.lower() or cat["slug"] == args.category:
                    cat_match = cat
                    break
            if cat_match:
                data["category_id"] = cat_match["id"]
            else:
                print(f"Warning: Category '{args.category}' not found, uploading without category")

        try:
            with httpx.Client(timeout=None) as client:
                response = client.post(f"{API_BASE}/videos", files=files, data=data)

            if response.status_code == 200:
                result = response.json()
                print(f"Success! Video queued for processing.")
                print(f"  ID: {result['video_id']}")
                print(f"  Slug: {result['slug']}")
            else:
                print(f"Error: {response.text}")
                sys.exit(1)
        except httpx.ConnectError:
            print(f"Error: Could not connect to admin API at {API_BASE}")
            print("Make sure the admin server is running.")
            sys.exit(1)


def cmd_list(args):
    """List videos."""
    try:
        params = {}
        if args.status:
            params["status"] = args.status

        response = httpx.get(f"{API_BASE}/videos", params=params)
        videos = response.json()

        if not videos:
            print("No videos found.")
            return

        print(f"{'ID':<5} {'Status':<12} {'Title':<40} {'Category':<15}")
        print("-" * 75)
        for v in videos:
            title = v["title"][:38] + ".." if len(v["title"]) > 40 else v["title"]
            cat = v["category_name"] or "-"
            print(f"{v['id']:<5} {v['status']:<12} {title:<40} {cat:<15}")

    except httpx.ConnectError:
        print(f"Error: Could not connect to admin API at {API_BASE}")
        sys.exit(1)


def cmd_categories(args):
    """List or create categories."""
    try:
        if args.create:
            response = httpx.post(
                f"{API_BASE}/categories",
                json={"name": args.create, "description": args.description or ""}
            )
            if response.status_code == 200:
                cat = response.json()
                print(f"Created category: {cat['name']} (slug: {cat['slug']})")
            else:
                print(f"Error: {response.json().get('detail', response.text)}")
                sys.exit(1)
        else:
            response = httpx.get(f"{API_BASE}/categories")
            categories = response.json()

            if not categories:
                print("No categories found.")
                return

            print(f"{'ID':<5} {'Name':<25} {'Slug':<25} {'Videos':<10}")
            print("-" * 65)
            for c in categories:
                print(f"{c['id']:<5} {c['name']:<25} {c['slug']:<25} {c['video_count']:<10}")

    except httpx.ConnectError:
        print(f"Error: Could not connect to admin API at {API_BASE}")
        sys.exit(1)


def cmd_delete(args):
    """Delete a video."""
    try:
        response = httpx.delete(f"{API_BASE}/videos/{args.video_id}")
        if response.status_code == 200:
            print(f"Video {args.video_id} deleted.")
        else:
            print(f"Error: {response.text}")
            sys.exit(1)
    except httpx.ConnectError:
        print(f"Error: Could not connect to admin API at {API_BASE}")
        sys.exit(1)


def cmd_download(args):
    """Download a video from YouTube and upload it."""
    try:
        import subprocess
        import tempfile
    except ImportError:
        print("Error: Required modules not available")
        sys.exit(1)

    # Check if yt-dlp is available
    try:
        subprocess.run(["yt-dlp", "--version"], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: yt-dlp is not installed. Install with: pip install yt-dlp")
        sys.exit(1)

    print(f"Downloading from YouTube: {args.url}")

    with tempfile.TemporaryDirectory() as tmpdir:
        output_template = f"{tmpdir}/%(title)s.%(ext)s"

        cmd = [
            "yt-dlp",
            "-f", "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best",
            "--merge-output-format", "mp4",
            "-o", output_template,
            args.url
        ]

        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=DOWNLOAD_TIMEOUT)
        except subprocess.TimeoutExpired:
            print(f"Error: Download timed out after {DOWNLOAD_TIMEOUT} seconds")
            print("You can increase the timeout with VLOG_DOWNLOAD_TIMEOUT environment variable")
            sys.exit(1)

        if result.returncode != 0:
            print(f"Error downloading: {result.stderr}")
            sys.exit(1)

        # Find the downloaded file
        downloaded = list(Path(tmpdir).glob("*.mp4"))
        if not downloaded:
            downloaded = list(Path(tmpdir).glob("*"))

        if not downloaded:
            print("Error: No file was downloaded")
            sys.exit(1)

        video_file = downloaded[0]
        title = args.title or video_file.stem

        print(f"Downloaded: {video_file.name}")
        print(f"Uploading as: {title}")

        # Upload the video
        with open(video_file, "rb") as f:
            files = {"file": (video_file.name, f)}
            data = {
                "title": title,
                "description": args.description or "",
            }
            if args.category:
                cats = httpx.get(f"{API_BASE}/categories").json()
                for cat in cats:
                    if cat["name"].lower() == args.category.lower() or cat["slug"] == args.category:
                        data["category_id"] = cat["id"]
                        break

            with httpx.Client(timeout=None) as client:
                response = client.post(f"{API_BASE}/videos", files=files, data=data)

            if response.status_code == 200:
                result = response.json()
                print(f"Success! Video queued for processing.")
                print(f"  ID: {result['video_id']}")
                print(f"  Slug: {result['slug']}")
            else:
                print(f"Error: {response.text}")
                sys.exit(1)


def main():
    parser = argparse.ArgumentParser(
        prog="vlog",
        description="VLog CLI - Manage your video library"
    )
    subparsers = parser.add_subparsers(dest="command", required=True)

    # Upload command
    upload_parser = subparsers.add_parser("upload", help="Upload a video file")
    upload_parser.add_argument("file", help="Video file to upload")
    upload_parser.add_argument("-t", "--title", help="Video title (default: filename)")
    upload_parser.add_argument("-d", "--description", help="Video description")
    upload_parser.add_argument("-c", "--category", help="Category name or slug")
    upload_parser.set_defaults(func=cmd_upload)

    # List command
    list_parser = subparsers.add_parser("list", help="List videos")
    list_parser.add_argument("-s", "--status", choices=["pending", "processing", "ready", "failed"], help="Filter by status")
    list_parser.set_defaults(func=cmd_list)

    # Categories command
    cat_parser = subparsers.add_parser("categories", help="List or create categories")
    cat_parser.add_argument("--create", metavar="NAME", help="Create a new category")
    cat_parser.add_argument("-d", "--description", help="Category description (with --create)")
    cat_parser.set_defaults(func=cmd_categories)

    # Delete command
    del_parser = subparsers.add_parser("delete", help="Delete a video")
    del_parser.add_argument("video_id", type=int, help="Video ID to delete")
    del_parser.set_defaults(func=cmd_delete)

    # Download command (from YouTube)
    dl_parser = subparsers.add_parser("download", help="Download from YouTube and upload")
    dl_parser.add_argument("url", help="YouTube URL")
    dl_parser.add_argument("-t", "--title", help="Override video title")
    dl_parser.add_argument("-d", "--description", help="Video description")
    dl_parser.add_argument("-c", "--category", help="Category name or slug")
    dl_parser.set_defaults(func=cmd_download)

    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()
