# VLog Configuration
# Copy this file to .env and modify as needed.
# All values shown are the defaults.

# =============================================================================
# Storage Paths
# =============================================================================

# Base storage path for all video files
VLOG_STORAGE_PATH=/mnt/nas/vlog-storage

# Subdirectories within storage path
VLOG_VIDEOS_SUBDIR=videos
VLOG_UPLOADS_SUBDIR=uploads
VLOG_ARCHIVE_SUBDIR=archive

# SQLite database path (keep local for performance)
VLOG_DATABASE_PATH=./vlog.db

# PostgreSQL database URL (recommended for production)
# VLOG_DATABASE_URL=postgresql://vlog:vlog_password@localhost/vlog

# =============================================================================
# Storage Health Check
# =============================================================================

# Timeout for health check storage access test (seconds)
# Reduced default for faster failure detection on stale NFS mounts
VLOG_STORAGE_CHECK_TIMEOUT=2

# =============================================================================
# Server Ports
# =============================================================================

# Public API port (video browsing, playback, analytics)
VLOG_PUBLIC_PORT=9000

# Admin API port (uploads, management - internal only)
VLOG_ADMIN_PORT=9001

# Admin API authentication secret (optional)
# When set, all /api/* endpoints require X-Admin-Secret header
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
# VLOG_ADMIN_API_SECRET=your-secret-here

# =============================================================================
# Worker Settings
# =============================================================================

# Use inotify-based filesystem watcher instead of polling
VLOG_WORKER_USE_FILESYSTEM_WATCHER=true

# Fallback poll interval in seconds (safety net)
VLOG_WORKER_FALLBACK_POLL_INTERVAL=60

# Debounce delay in seconds after file event
VLOG_WORKER_DEBOUNCE_DELAY=1.0

# Progress update rate limiting (prevents database overload during transcoding)
VLOG_PROGRESS_UPDATE_INTERVAL=5.0

# =============================================================================
# Remote Worker Settings (Distributed Transcoding)
# =============================================================================

# Worker API port (for remote transcoder registration and job claiming)
VLOG_WORKER_API_PORT=9002

# Worker API URL (used by remote workers to connect to the server)
VLOG_WORKER_API_URL=http://localhost:9002

# Worker API key (issued when registering via `vlog worker register`)
# VLOG_WORKER_API_KEY=vlog_xxxx...

# Admin secret for worker management endpoints (register, list, revoke)
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
# VLOG_WORKER_ADMIN_SECRET=your-secret-here

# Heartbeat interval in seconds (how often workers send status updates)
VLOG_WORKER_HEARTBEAT_INTERVAL=30

# How long a worker can claim a job before it expires (minutes)
VLOG_WORKER_CLAIM_DURATION=30

# How often remote workers poll for new jobs (seconds)
VLOG_WORKER_POLL_INTERVAL=10

# Local directory for remote workers to use during transcoding
VLOG_WORKER_WORK_DIR=/tmp/vlog-worker

# Minutes before a worker is considered offline (no heartbeat)
VLOG_WORKER_OFFLINE_THRESHOLD=2

# How often to check for stale jobs from offline workers (seconds)
VLOG_STALE_JOB_CHECK_INTERVAL=60

# =============================================================================
# Soft Delete
# =============================================================================

# Days to keep archived videos before permanent deletion
VLOG_ARCHIVE_RETENTION_DAYS=30

# =============================================================================
# HLS Settings
# =============================================================================

# Segment duration in seconds
VLOG_HLS_SEGMENT_DURATION=6

# =============================================================================
# Thumbnail Settings
# =============================================================================

# Maximum custom thumbnail upload size in bytes (10MB default)
VLOG_MAX_THUMBNAIL_SIZE=10485760

# Thumbnail width in pixels (height auto-calculated to maintain aspect ratio)
VLOG_THUMBNAIL_WIDTH=640

# =============================================================================
# Hardware Acceleration
# =============================================================================

# Hardware acceleration type: auto, nvidia, intel, none
VLOG_HWACCEL_TYPE=auto

# Preferred codec: h264, hevc, av1
VLOG_HWACCEL_PREFERRED_CODEC=h264

# Fall back to CPU if GPU encoding fails
VLOG_HWACCEL_FALLBACK_TO_CPU=true

# Maximum concurrent GPU encoding sessions (consumer GPUs have limits)
VLOG_HWACCEL_MAX_SESSIONS=3

# VAAPI device path (Intel GPU, leave empty for auto-detect)
# VLOG_HWACCEL_VAAPI_DEVICE=/dev/dri/renderD128

# =============================================================================
# Parallel Quality Encoding
# =============================================================================

# Number of qualities to encode simultaneously (1 = sequential)
# Recommended: 3 for GPUs, 1 for CPU-only
VLOG_PARALLEL_QUALITIES=1

# Auto-detect optimal parallelism based on GPU capabilities
# When true: uses min(3, gpu.max_sessions - 1) for GPUs
VLOG_PARALLEL_QUALITIES_AUTO=true

# =============================================================================
# Transcoding Settings
# =============================================================================

# Checkpoint interval in seconds
VLOG_CHECKPOINT_INTERVAL=30

# Seconds before a job is considered stale (30 min default)
VLOG_JOB_STALE_TIMEOUT=1800

# Maximum retry attempts for failed jobs
VLOG_MAX_RETRY_ATTEMPTS=3

# Backoff base in seconds (doubles each retry)
VLOG_RETRY_BACKOFF_BASE=60

# Clean up partial files on failure
VLOG_CLEANUP_PARTIAL_ON_FAILURE=true

# Clean up source files when transcoding permanently fails (after max retries)
VLOG_CLEANUP_SOURCE_ON_PERMANENT_FAILURE=true

# Keep completed qualities on retry (don't re-transcode)
VLOG_KEEP_COMPLETED_QUALITIES=true

# =============================================================================
# FFmpeg Timeout Settings
# =============================================================================

# Base timeout multiplier (timeout = video_duration * multiplier * resolution_factor)
VLOG_FFMPEG_TIMEOUT_BASE_MULTIPLIER=2.0

# Minimum timeout in seconds (5 minutes)
VLOG_FFMPEG_TIMEOUT_MINIMUM=300

# Maximum timeout in seconds (1 hour)
VLOG_FFMPEG_TIMEOUT_MAXIMUM=3600

# =============================================================================
# Transcription Settings (Whisper)
# =============================================================================

# Whisper model: tiny, base, small, medium, large-v3
VLOG_WHISPER_MODEL=medium

# Enable/disable auto-transcription
VLOG_TRANSCRIPTION_ENABLED=true

# Language code for transcription (leave empty for auto-detect)
# VLOG_TRANSCRIPTION_LANGUAGE=en

# Auto-transcribe new uploads
VLOG_TRANSCRIPTION_ON_UPLOAD=true

# Compute type for faster-whisper: float16, int8, int8_float16
VLOG_TRANSCRIPTION_COMPUTE_TYPE=int8

# Transcription timeout in seconds (1 hour)
VLOG_TRANSCRIPTION_TIMEOUT=3600

# Audio extraction timeout in seconds (5 minutes)
VLOG_AUDIO_EXTRACTION_TIMEOUT=300

# =============================================================================
# Upload Limits
# =============================================================================

# Maximum upload size in bytes (100GB default)
VLOG_MAX_UPLOAD_SIZE=107374182400

# Upload chunk size in bytes (1MB default)
VLOG_UPLOAD_CHUNK_SIZE=1048576

# HLS archive extraction limits (tar bomb protection)
# Max files in HLS archive (50k supports ~8hr videos with all qualities)
VLOG_MAX_HLS_ARCHIVE_FILES=50000
# Max total extracted size in bytes (200GB)
VLOG_MAX_HLS_ARCHIVE_SIZE=214748364800
# Max single file size in bytes (500MB)
VLOG_MAX_HLS_SINGLE_FILE_SIZE=524288000

# =============================================================================
# CORS Configuration
# =============================================================================

# Allowed origins for public API (comma-separated)
# Leave empty for same-origin only
# VLOG_CORS_ORIGINS=http://localhost:9000,http://localhost:9001

# Allowed origins for admin API (comma-separated)
# Defaults to * since admin is internal-only
# VLOG_ADMIN_CORS_ORIGINS=*

# =============================================================================
# Rate Limiting
# =============================================================================

# Enable/disable rate limiting
VLOG_RATE_LIMIT_ENABLED=true

# Public API rate limits
VLOG_RATE_LIMIT_PUBLIC_DEFAULT=100/minute
VLOG_RATE_LIMIT_PUBLIC_VIDEOS_LIST=60/minute
VLOG_RATE_LIMIT_PUBLIC_ANALYTICS=120/minute

# Admin API rate limits
VLOG_RATE_LIMIT_ADMIN_DEFAULT=200/minute
VLOG_RATE_LIMIT_ADMIN_UPLOAD=10/hour

# Worker API rate limits
VLOG_RATE_LIMIT_WORKER_DEFAULT=300/minute
VLOG_RATE_LIMIT_WORKER_REGISTER=5/hour
VLOG_RATE_LIMIT_WORKER_PROGRESS=600/minute

# Rate limit storage backend
# Use "memory://" for single instance, or Redis URL for multi-instance:
# VLOG_RATE_LIMIT_STORAGE_URL=redis://localhost:6379/0
VLOG_RATE_LIMIT_STORAGE_URL=memory://

# Trusted proxy IPs for X-Forwarded-For header (comma-separated)
# Leave empty to never trust X-Forwarded-For (prevents rate limit bypass)
# VLOG_TRUSTED_PROXIES=127.0.0.1,10.0.0.1

# =============================================================================
# Cookie Security
# =============================================================================

# Set secure flag on cookies (requires HTTPS)
# Disable for local development without HTTPS
VLOG_SECURE_COOKIES=true

# =============================================================================
# Analytics Caching
# =============================================================================

# Enable/disable analytics caching
VLOG_ANALYTICS_CACHE_ENABLED=true

# Server-side cache TTL in seconds
VLOG_ANALYTICS_CACHE_TTL=60

# Client-side Cache-Control max-age in seconds
VLOG_ANALYTICS_CLIENT_CACHE_MAX_AGE=60

# Analytics cache storage backend
# Use "memory://" for single instance, or Redis URL for multi-instance:
# VLOG_ANALYTICS_CACHE_STORAGE_URL=redis://localhost:6379/0
VLOG_ANALYTICS_CACHE_STORAGE_URL=memory://

# =============================================================================
# Audit Logging
# =============================================================================

# Enable/disable audit logging for administrative actions
VLOG_AUDIT_LOG_ENABLED=true

# Path to audit log file (directory will be created if it doesn't exist)
VLOG_AUDIT_LOG_PATH=/var/log/vlog/audit.log

# Audit log level (DEBUG, INFO, WARNING, ERROR)
VLOG_AUDIT_LOG_LEVEL=INFO

# =============================================================================
# Error Message Settings
# =============================================================================

# Maximum length for brief error summaries (shown in API responses)
VLOG_ERROR_SUMMARY_MAX_LENGTH=100

# Maximum length for detailed error messages
VLOG_ERROR_DETAIL_MAX_LENGTH=500

# Maximum length for full error logs
VLOG_ERROR_LOG_MAX_LENGTH=2000

# =============================================================================
# Alerting Configuration
# =============================================================================

# Webhook URL for sending alerts (stale jobs, max retries exceeded, etc.)
# Leave empty to disable webhook alerts
# VLOG_ALERT_WEBHOOK_URL=https://hooks.slack.com/services/xxx

# Timeout for webhook requests in seconds
VLOG_ALERT_WEBHOOK_TIMEOUT=10

# Minimum interval between alerts for the same event type (seconds)
# Prevents alert flooding when multiple jobs fail in quick succession
VLOG_ALERT_RATE_LIMIT_SECONDS=300

# =============================================================================
# Redis Configuration
# =============================================================================

# Redis URL for job queue and pub/sub (leave empty to disable Redis features)
# VLOG_REDIS_URL=redis://localhost:6379

# Redis connection pool size
VLOG_REDIS_POOL_SIZE=10

# Redis socket timeouts in seconds
VLOG_REDIS_SOCKET_TIMEOUT=5.0
VLOG_REDIS_SOCKET_CONNECT_TIMEOUT=5.0

# Redis health check interval in seconds
VLOG_REDIS_HEALTH_CHECK_INTERVAL=30

# Job queue mode: database (default), redis, or hybrid
VLOG_JOB_QUEUE_MODE=database

# Redis Streams settings
VLOG_REDIS_STREAM_MAX_LEN=10000
VLOG_REDIS_CONSUMER_GROUP=vlog-workers
VLOG_REDIS_CONSUMER_BLOCK_MS=5000
VLOG_REDIS_PENDING_TIMEOUT_MS=300000

# Redis Pub/Sub channel prefix
VLOG_REDIS_PUBSUB_PREFIX=vlog

# SSE (Server-Sent Events) settings
VLOG_SSE_HEARTBEAT_INTERVAL=30
VLOG_SSE_RECONNECT_TIMEOUT_MS=3000

# =============================================================================
# CLI Configuration
# =============================================================================

# Admin API URL for CLI (overrides VLOG_ADMIN_PORT if set)
# VLOG_ADMIN_API_URL=http://localhost:9001

# API request timeout in seconds
VLOG_API_TIMEOUT=30

# Upload timeout in seconds (2 hours default for large files)
VLOG_UPLOAD_TIMEOUT=7200

# Download timeout for yt-dlp in seconds
VLOG_DOWNLOAD_TIMEOUT=3600

# =============================================================================
# Testing
# =============================================================================

# Set to skip directory creation (for CI/tests)
# VLOG_TEST_MODE=1
