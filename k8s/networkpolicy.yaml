# VLog Worker NetworkPolicy
# kubectl apply -f k8s/networkpolicy.yaml
#
# This policy restricts network access for worker pods to minimize
# the blast radius if a pod is compromised. Workers only need:
# 1. Egress to the Worker API (port 9002)
# 2. Egress to DNS for hostname resolution
# 3. Optionally, egress to Redis for job queue (port 6379)
#
# IMPORTANT: This policy requires a CNI that supports NetworkPolicy
# (e.g., Calico, Cilium, Weave Net). Default k3s/k8s networking
# does NOT enforce NetworkPolicy without a compatible CNI.
#
# Verify your CNI supports NetworkPolicy before relying on this.
#
# CONFIGURATION REQUIRED: You must customize the Worker API egress rule
# below to match your deployment. See comments for options.

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vlog-worker-network-policy
  namespace: vlog
  labels:
    app.kubernetes.io/name: vlog
    app.kubernetes.io/component: worker
spec:
  # Apply to all worker pods
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vlog
      app.kubernetes.io/component: worker

  policyTypes:
    - Ingress
    - Egress

  # Workers don't need any inbound connections
  # Empty list = deny all ingress
  ingress: []

  egress:
    # Allow DNS resolution (required for external API URLs)
    # Targets the kube-system namespace where CoreDNS/kube-dns runs
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # =========================================================================
    # WORKER API EGRESS - CONFIGURATION REQUIRED
    # =========================================================================
    # Workers need to communicate with the Worker API for job polling,
    # status updates, and file uploads. Configure this based on your deployment.
    #
    # OPTION A (enabled below): External Worker API with specific IP/CIDR
    # Replace the CIDR with your Worker API server's IP address or range.
    # Examples:
    #   - 192.168.1.100/32  (single host)
    #   - 10.0.0.0/24       (entire subnet)
    #   - 10.0.1.1/32       (your VLog server)
    #
    - to:
        - ipBlock:
            # REQUIRED: Replace with your Worker API server IP/CIDR
            cidr: 10.0.0.0/8  # Default: Allow entire private 10.x.x.x range
            # Optionally exclude specific IPs within the range:
            # except:
            #   - 10.0.0.1/32
      ports:
        - protocol: TCP
          port: 9002  # Worker API port
        - protocol: TCP
          port: 443   # HTTPS (if using TLS)

    # OPTION B (commented): In-cluster Worker API
    # Use this instead of Option A if the Worker API runs as a K8s service.
    # - to:
    #     - namespaceSelector:
    #         matchLabels:
    #           kubernetes.io/metadata.name: vlog
    #       podSelector:
    #         matchLabels:
    #           app.kubernetes.io/name: vlog
    #           app.kubernetes.io/component: worker-api
    #   ports:
    #     - protocol: TCP
    #       port: 9002

    # =========================================================================
    # REDIS EGRESS - OPTIONAL (for instant job dispatch)
    # =========================================================================
    # Enable this if using Redis pub/sub for real-time job notifications.
    # Without Redis, workers poll the API periodically (still works, just slower).
    #
    # OPTION A (enabled below): External Redis with specific IP/CIDR
    - to:
        - ipBlock:
            # Replace with your Redis server IP/CIDR (or comment out if not using Redis)
            cidr: 10.0.0.0/8  # Default: Allow entire private 10.x.x.x range
      ports:
        - protocol: TCP
          port: 6379  # Redis default port

    # OPTION B (commented): In-cluster Redis
    # - to:
    #     - namespaceSelector:
    #         matchLabels:
    #           kubernetes.io/metadata.name: vlog
    #       podSelector:
    #         matchLabels:
    #           app.kubernetes.io/name: redis
    #   ports:
    #     - protocol: TCP
    #       port: 6379

    # =========================================================================
    # NFS/SMB STORAGE EGRESS - OPTIONAL (for NAS storage)
    # =========================================================================
    # If workers access video storage over NFS or SMB, enable this.
    # Note: hostPath volumes don't require network egress.
    #
    # - to:
    #     - ipBlock:
    #         cidr: 10.0.0.0/8  # Replace with your NAS IP/CIDR
    #   ports:
    #     - protocol: TCP
    #       port: 2049  # NFS
    #     - protocol: TCP
    #       port: 445   # SMB
