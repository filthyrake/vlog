# VLog Worker Deployment with Intel Arc/QuickSync GPU Support
# kubectl apply -f k8s/worker-deployment-intel.yaml
#
# Prerequisites:
# 1. Intel GPU device plugin installed (intel/intel-device-plugins-for-kubernetes)
# 2. Nodes labeled with intel.feature.node.kubernetes.io/gpu=true
# 3. Build and push GPU worker image:
#    docker build -f Dockerfile.worker.gpu -t your-registry/vlog-worker-gpu:v1.0.0 .
#    docker push your-registry/vlog-worker-gpu:v1.0.0
# 4. Create the secret with your API key (see secret.yaml)
# 5. Update the ConfigMap with your API URL (see configmap.yaml)

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vlog-worker-intel
  namespace: vlog
  labels:
    app.kubernetes.io/name: vlog
    app.kubernetes.io/component: worker
    app.kubernetes.io/gpu-type: intel
spec:
  replicas: 1
  # Use Recreate strategy since GPU resources can't be shared between old/new pods
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: vlog
      app.kubernetes.io/component: worker
      app.kubernetes.io/gpu-type: intel
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vlog
        app.kubernetes.io/component: worker
        app.kubernetes.io/gpu-type: intel
    spec:
      # Security context - need video group for /dev/dri access
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 44  # video group
        seccompProfile:
          type: RuntimeDefault

      containers:
      - name: worker
        # GPU-enabled worker image from local registry
        image: 10.0.1.152:9003/vlog-worker-gpu:rocky10
        imagePullPolicy: IfNotPresent

        # Load environment from ConfigMap
        envFrom:
        - configMapRef:
            name: vlog-worker-config

        # Environment variables
        env:
        # API key from secret
        - name: VLOG_WORKER_API_KEY
          valueFrom:
            secretKeyRef:
              name: vlog-worker-secret
              key: intel-api-key
        # GPU-specific settings
        - name: VLOG_HWACCEL_TYPE
          value: "intel"
        - name: VLOG_HWACCEL_PREFERRED_CODEC
          value: "h264"  # AV1 not supported in HLS/MPEG-TS containers yet
        # Intel Media Driver (iHD) for Arc GPUs
        - name: LIBVA_DRIVER_NAME
          value: "iHD"
        # Work directory - must have adequate disk space (NOT /tmp!)
        - name: VLOG_WORKER_WORK_DIR
          value: "/home/vlog-worker"

        # Resource limits
        resources:
          requests:
            memory: "4Gi"
            cpu: "1000m"
            gpu.intel.com/xe: 1  # Arc B580 uses xe driver
          limits:
            memory: "8Gi"
            cpu: "2000m"
            gpu.intel.com/xe: 1

        # Mount volumes - use /home for persistent storage with adequate disk space
        volumeMounts:
        - name: work-dir
          mountPath: /home/vlog-worker
        # DRI device access for VAAPI
        - name: dri
          mountPath: /dev/dri

        # Liveness probe - worker process is alive
        # Checks /health endpoint on built-in health server (port 8080)
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 60
          timeoutSeconds: 5
          failureThreshold: 3

        # Readiness probe - worker can accept jobs
        # Checks /ready endpoint which verifies API connection and FFmpeg availability
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        # Security context
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL

      # Volumes
      volumes:
      - name: work-dir
        hostPath:
          path: /home/vlog-worker
          type: DirectoryOrCreate
      # Host path for GPU device access
      - name: dri
        hostPath:
          path: /dev/dri
          type: Directory

      # Grace period for job completion
      terminationGracePeriodSeconds: 300

      restartPolicy: Always

      # Node selector for Intel GPU nodes
      nodeSelector:
        intel.feature.node.kubernetes.io/gpu: "true"

      # Toleration for Intel GPU nodes (if using taints)
      tolerations:
      - key: "gpu.intel.com/i915"
        operator: "Exists"
        effect: "NoSchedule"
