<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob: https://cdn.damenknight.com; connect-src 'self' https://cdn.damenknight.com; font-src 'self';">
    <title>Damen's VLog</title>
    <link rel="stylesheet" href="/static/vendor/tailwind.css">
    <link rel="stylesheet" href="/static/css/bundle.css">
    <style>[x-cloak] { display: none !important; }</style>
    <script src="/static/js/utils.js"></script>
    <script defer src="/static/vendor/alpine.min.js"></script>
</head>
<body class="bg-dark-950 text-dark-100 min-h-screen flex flex-col" x-data="app()">
    <!-- Skip to main content link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Screen reader announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" x-text="announcement"></div>

    <!-- Header -->
    <header class="site-header">
        <div class="site-header__container">
            <a href="/" class="site-header__logo">Damen's VLog</a>

            <!-- Search -->
            <div role="search" class="site-header__search">
                <label for="search-input" class="sr-only">Search videos</label>
                <input
                    id="search-input"
                    type="search"
                    placeholder="Search videos..."
                    class="site-header__search-input"
                    x-model="searchQuery"
                    @input.debounce.300ms="loadVideos()"
                    @keydown.escape="clearSearch()"
                >
                <!-- Result count -->
                <span
                    class="site-header__search-count"
                    :class="{ 'site-header__search-count--has-clear': searchQuery }"
                    x-show="searchQuery && !loading"
                    x-text="videos.length + ' result' + (videos.length === 1 ? '' : 's')"
                ></span>
                <!-- Clear button -->
                <button
                    type="button"
                    class="site-header__search-clear"
                    :class="{ 'site-header__search-clear--visible': searchQuery }"
                    @click="clearSearch()"
                    aria-label="Clear search"
                >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Mobile menu button -->
            <button
                type="button"
                class="site-header__menu-btn"
                @click="mobileNavOpen = true"
                aria-label="Open menu"
                aria-expanded="false"
                :aria-expanded="mobileNavOpen"
            >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <!-- Desktop nav -->
            <nav class="site-header__nav">
                <a href="/" class="site-header__nav-link site-header__nav-link--active">Home</a>
            </nav>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <div
        class="mobile-nav"
        :class="{ 'mobile-nav--open': mobileNavOpen }"
        x-show="mobileNavOpen"
        x-cloak
        @keydown.escape.window="mobileNavOpen = false"
    >
        <div class="mobile-nav__backdrop" @click="mobileNavOpen = false"></div>
        <div class="mobile-nav__drawer" role="dialog" aria-modal="true" aria-label="Navigation menu">
            <div class="mobile-nav__header">
                <span class="mobile-nav__title">Menu</span>
                <button
                    type="button"
                    class="mobile-nav__close"
                    @click="mobileNavOpen = false"
                    aria-label="Close menu"
                >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <nav class="mobile-nav__content">
                <div class="mobile-nav__section">
                    <div class="mobile-nav__section-title">Navigation</div>
                    <a href="/" class="mobile-nav__link mobile-nav__link--active">Home</a>
                </div>
                <div class="mobile-nav__section" x-show="categories.length > 0">
                    <div class="mobile-nav__section-title">Categories</div>
                    <template x-for="cat in categories" :key="cat.id">
                        <a
                            :href="'/category/' + cat.slug"
                            class="mobile-nav__link"
                            x-text="cat.name"
                        ></a>
                    </template>
                </div>
            </nav>
        </div>
    </div>

    <main id="main-content" class="max-w-7xl mx-auto px-4 py-8">
        <!-- Categories -->
        <section class="mb-8" x-show="categories.length > 0">
            <h2 class="text-xl font-semibold mb-4">Categories</h2>
            <div class="flex flex-wrap gap-3">
                <button
                    @click="selectedCategory = null; loadVideos()"
                    :class="selectedCategory === null ? 'bg-blue-600 text-white' : 'bg-dark-800 text-dark-300 hover:bg-dark-700'"
                    class="px-4 py-2 rounded-lg transition"
                >
                    All
                </button>
                <template x-for="cat in categories" :key="cat.id">
                    <button
                        @click="selectedCategory = cat.slug; loadVideos()"
                        :class="selectedCategory === cat.slug ? 'bg-blue-600 text-white' : 'bg-dark-800 text-dark-300 hover:bg-dark-700'"
                        class="px-4 py-2 rounded-lg transition"
                    >
                        <span x-text="cat.name"></span>
                        <span class="text-dark-400 ml-1" x-text="'(' + cat.video_count + ')'"></span>
                    </button>
                </template>
            </div>
        </section>

        <!-- Videos Grid -->
        <section>
            <h2 class="text-xl font-semibold mb-4" x-text="selectedCategory ? 'Videos' : 'Latest Videos'"></h2>

            <div x-show="loading" class="flex justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-dark-700 border-t-blue-500"></div>
            </div>

            <div x-show="!loading && videos.length === 0" class="text-center py-12">
                <svg class="mx-auto h-16 w-16 text-dark-600 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="6" width="20" height="12" rx="2" ry="2"></rect>
                    <path d="M10 12l4-2.5v5L10 12z" fill="currentColor" stroke="none"></path>
                </svg>
                <h3 class="text-lg font-medium text-dark-300 mb-2" x-text="searchQuery ? 'No videos match your search' : 'No videos found'"></h3>
                <p class="text-dark-500 mb-4" x-text="searchQuery ? 'Try adjusting your search terms or browse all videos.' : 'Check back soon for new content!'"></p>
                <button
                    x-show="searchQuery"
                    @click="clearSearch()"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-dark-800 hover:bg-dark-700 text-dark-300 rounded-lg transition"
                >
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Clear search
                </button>
            </div>

            <div x-show="!loading && videos.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <template x-for="video in videos" :key="video.id">
                    <a :href="'/watch/' + video.slug" class="group">
                        <div class="bg-dark-800 rounded-xl overflow-hidden hover:ring-2 hover:ring-blue-500 transition">
                            <div class="aspect-video bg-dark-900 relative">
                                <img
                                    :src="video.thumbnail_url"
                                    :alt="video.title"
                                    class="w-full h-full object-cover"
                                    loading="lazy"
                                    @error="$el.style.display='none'"
                                >
                                <div class="absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-sm">
                                    <span x-text="formatDuration(video.duration)"></span>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-medium text-white group-hover:text-blue-400 line-clamp-2" x-text="video.title"></h3>
                                <p class="text-dark-400 text-sm mt-1" x-text="video.category_name || 'Uncategorized'"></p>
                                <p class="text-dark-400 text-sm mt-1" x-text="formatDate(video.published_at)"></p>
                            </div>
                        </div>
                    </a>
                </template>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="site-footer__container">
            <div class="site-footer__content">
                <div class="site-footer__brand">
                    <a href="/" class="site-footer__logo">Damen's VLog</a>
                    <p class="site-footer__tagline">Automotive adventures and insights</p>
                </div>
                <nav class="site-footer__nav" aria-label="Footer navigation">
                    <div class="site-footer__nav-group">
                        <div class="site-footer__nav-title">Browse</div>
                        <a href="/" class="site-footer__nav-link">All Videos</a>
                    </div>
                </nav>
            </div>
            <div class="site-footer__bottom">
                <p class="site-footer__copyright">&copy; <span x-text="new Date().getFullYear()"></span> Damen's VLog. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        function app() {
            return {
                videos: [],
                categories: [],
                loading: true,
                searchQuery: '',
                selectedCategory: null,
                announcement: '', // For screen reader announcements
                mobileNavOpen: false,

                async init() {
                    // Check for search param from URL (e.g., from watch page search)
                    const urlParams = new URLSearchParams(window.location.search);
                    const searchParam = urlParams.get('search') || urlParams.get('q');
                    if (searchParam) {
                        this.searchQuery = searchParam;
                        // Clean URL without reloading
                        window.history.replaceState({}, '', '/');
                    }

                    await Promise.all([
                        this.loadCategories(),
                        this.loadVideos()
                    ]);
                },

                async loadCategories() {
                    try {
                        const res = await VLogUtils.fetchWithTimeout('/api/categories', {}, 10000);
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        this.categories = await res.json();
                    } catch (e) {
                        console.error('Failed to load categories:', e);
                        this.categories = [];
                    }
                },

                async loadVideos() {
                    this.loading = true;
                    try {
                        let url = '/api/videos?';
                        if (this.selectedCategory) {
                            url += `category=${this.selectedCategory}&`;
                        }
                        if (this.searchQuery) {
                            url += `search=${encodeURIComponent(this.searchQuery)}&`;
                        }
                        const res = await VLogUtils.fetchWithTimeout(url, {}, 10000);
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        this.videos = await res.json();
                        // Announce results to screen readers
                        this.announcement = `${this.videos.length} video${this.videos.length === 1 ? '' : 's'} found`;
                    } catch (e) {
                        console.error('Failed to load videos:', e);
                        this.videos = [];
                        this.announcement = 'Failed to load videos';
                    } finally {
                        this.loading = false;
                    }
                },

                formatDuration(seconds) {
                    return VLogUtils.formatDuration(seconds);
                },

                formatDate(dateStr) {
                    return VLogUtils.formatDate(dateStr);
                },

                clearSearch() {
                    this.searchQuery = '';
                    this.loadVideos();
                    document.getElementById('search-input')?.focus();
                }
            };
        }
    </script>
</body>
</html>
