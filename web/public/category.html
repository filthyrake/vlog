<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob: https://cdn.damenknight.com; connect-src 'self' https://cdn.damenknight.com; font-src 'self';">
    <title>Category - Damen's VLog</title>
    <link rel="stylesheet" href="/static/vendor/tailwind.css">
    <link rel="stylesheet" href="/static/css/bundle.css">
    <style>[x-cloak] { display: none !important; }</style>
    <script src="/static/js/utils.js"></script>
    <script defer src="/static/vendor/alpine.min.js"></script>
</head>
<body class="bg-dark-950 text-dark-100 min-h-screen flex flex-col" x-data="categoryPage()">
    <!-- Skip to main content link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Screen reader announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" x-text="announcement"></div>

    <!-- Header -->
    <header class="site-header">
        <div class="site-header__container">
            <a href="/" class="site-header__logo">Damen's VLog</a>

            <!-- Search -->
            <div role="search" class="site-header__search">
                <label for="search-input" class="sr-only">Search videos in this category</label>
                <input
                    id="search-input"
                    type="search"
                    placeholder="Search in category..."
                    class="site-header__search-input"
                    x-model="searchQuery"
                    @input.debounce.300ms="filterVideos()"
                    @keydown.escape="clearSearch()"
                >
                <!-- Result count -->
                <span
                    class="site-header__search-count"
                    :class="{ 'site-header__search-count--has-clear': searchQuery }"
                    x-show="searchQuery && !loading"
                    x-text="filteredVideos.length + ' result' + (filteredVideos.length === 1 ? '' : 's')"
                ></span>
                <!-- Clear button -->
                <button
                    type="button"
                    class="site-header__search-clear"
                    :class="{ 'site-header__search-clear--visible': searchQuery }"
                    @click="clearSearch()"
                    aria-label="Clear search"
                >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Mobile menu button -->
            <button
                type="button"
                class="site-header__menu-btn"
                @click="mobileNavOpen = true"
                aria-label="Open menu"
                :aria-expanded="mobileNavOpen"
            >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <!-- Desktop nav -->
            <nav class="site-header__nav">
                <a href="/" class="site-header__nav-link">Home</a>
            </nav>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <div
        class="mobile-nav"
        :class="{ 'mobile-nav--open': mobileNavOpen }"
        x-show="mobileNavOpen"
        x-cloak
        @keydown.escape.window="mobileNavOpen = false"
    >
        <div class="mobile-nav__backdrop" @click="mobileNavOpen = false"></div>
        <div class="mobile-nav__drawer" role="dialog" aria-modal="true" aria-label="Navigation menu">
            <div class="mobile-nav__header">
                <span class="mobile-nav__title">Menu</span>
                <button
                    type="button"
                    class="mobile-nav__close"
                    @click="mobileNavOpen = false"
                    aria-label="Close menu"
                >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <nav class="mobile-nav__content">
                <div class="mobile-nav__section">
                    <div class="mobile-nav__section-title">Navigation</div>
                    <a href="/" class="mobile-nav__link">Home</a>
                </div>
            </nav>
        </div>
    </div>

    <main id="main-content" class="max-w-7xl mx-auto px-4 py-8 flex-1">
        <!-- Loading -->
        <div x-show="loading" class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-dark-700 border-t-blue-500"></div>
        </div>

        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="Breadcrumb" x-show="!loading && category">
            <ol class="breadcrumb__list">
                <li class="breadcrumb__item">
                    <a href="/" class="breadcrumb__link">Home</a>
                </li>
                <li class="breadcrumb__item">
                    <span class="breadcrumb__separator" aria-hidden="true">/</span>
                    <span class="breadcrumb__current" aria-current="page" x-text="category?.name"></span>
                </li>
            </ol>
        </nav>

        <!-- Category Header -->
        <div x-show="!loading && category" class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2" x-text="category?.name"></h1>
            <p class="text-dark-400" x-text="category?.description"></p>
            <p class="text-dark-400 mt-2" x-text="(searchQuery ? filteredVideos.length : category?.video_count) + ' video' + ((searchQuery ? filteredVideos.length : category?.video_count) === 1 ? '' : 's')"></p>
        </div>

        <!-- Videos Grid -->
        <div x-show="!loading && filteredVideos.length === 0" class="text-center py-12">
            <svg class="mx-auto h-16 w-16 text-dark-600 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="2" y="6" width="20" height="12" rx="2" ry="2"></rect>
                <path d="M10 12l4-2.5v5L10 12z" fill="currentColor" stroke="none"></path>
            </svg>
            <h3 class="text-lg font-medium text-dark-300 mb-2" x-text="searchQuery ? 'No videos match your search' : 'No videos in this category yet'"></h3>
            <p class="text-dark-500 mb-4" x-text="searchQuery ? 'Try adjusting your search terms.' : 'Check back soon for new content!'"></p>
            <button
                x-show="searchQuery"
                @click="clearSearch()"
                class="inline-flex items-center gap-2 px-4 py-2 bg-dark-800 hover:bg-dark-700 text-dark-300 rounded-lg transition"
            >
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Clear search
            </button>
        </div>

        <div x-show="!loading && filteredVideos.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <template x-for="video in filteredVideos" :key="video.id">
                <a :href="'/watch/' + video.slug" class="group">
                    <div class="bg-dark-800 rounded-xl overflow-hidden hover:ring-2 hover:ring-blue-500 transition">
                        <div class="aspect-video bg-dark-900 relative">
                            <img
                                :src="video.thumbnail_url"
                                :alt="video.title"
                                class="w-full h-full object-cover"
                                loading="lazy"
                                @error="$el.style.display='none'"
                            >
                            <div class="absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-sm">
                                <span x-text="formatDuration(video.duration)"></span>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-white group-hover:text-blue-400 line-clamp-2" x-text="video.title"></h3>
                            <p class="text-dark-400 text-sm mt-1" x-text="formatDate(video.published_at)"></p>
                        </div>
                    </div>
                </a>
            </template>
        </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="site-footer__container">
            <div class="site-footer__content">
                <div class="site-footer__brand">
                    <a href="/" class="site-footer__logo">Damen's VLog</a>
                    <p class="site-footer__tagline">Automotive adventures and insights</p>
                </div>
                <nav class="site-footer__nav" aria-label="Footer navigation">
                    <div class="site-footer__nav-group">
                        <div class="site-footer__nav-title">Browse</div>
                        <a href="/" class="site-footer__nav-link">All Videos</a>
                    </div>
                </nav>
            </div>
            <div class="site-footer__bottom">
                <p class="site-footer__copyright">&copy; <span x-text="new Date().getFullYear()"></span> Damen's VLog. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        function categoryPage() {
            return {
                category: null,
                videos: [],
                loading: true,
                announcement: '', // For screen reader announcements
                mobileNavOpen: false,
                searchQuery: '',

                get filteredVideos() {
                    if (!this.searchQuery) return this.videos;
                    const query = this.searchQuery.toLowerCase();
                    return this.videos.filter(v =>
                        v.title.toLowerCase().includes(query) ||
                        (v.description && v.description.toLowerCase().includes(query))
                    );
                },

                async init() {
                    const slug = window.location.pathname.split('/').pop();
                    if (!slug) {
                        window.location.href = '/';
                        return;
                    }

                    try {
                        const [catRes, videosRes] = await Promise.all([
                            VLogUtils.fetchWithTimeout(`/api/categories/${slug}`, {}, 10000),
                            VLogUtils.fetchWithTimeout(`/api/videos?category=${slug}`, {}, 10000)
                        ]);

                        if (!catRes.ok) {
                            window.location.href = '/';
                            return;
                        }

                        this.category = await catRes.json();
                        if (videosRes.ok) {
                            this.videos = await videosRes.json();
                            this.announcement = `${this.category.name} category with ${this.videos.length} video${this.videos.length === 1 ? '' : 's'}`;
                        } else {
                            console.error('Failed to load videos:', videosRes.status);
                            this.videos = [];
                            this.announcement = 'Failed to load videos';
                        }
                        document.title = `${this.category.name} - Damen's VLog`;
                    } catch (e) {
                        console.error('Failed to load category:', e);
                        this.announcement = 'Failed to load category';
                    } finally {
                        this.loading = false;
                    }
                },

                filterVideos() {
                    const count = this.filteredVideos.length;
                    this.announcement = `${count} video${count === 1 ? '' : 's'} found`;
                },

                clearSearch() {
                    this.searchQuery = '';
                    document.getElementById('search-input')?.focus();
                },

                formatDuration(seconds) {
                    return VLogUtils.formatDuration(seconds);
                },

                formatDate(dateStr) {
                    return VLogUtils.formatDate(dateStr);
                }
            };
        }
    </script>
</body>
</html>
